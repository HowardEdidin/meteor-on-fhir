{"version":3,"sources":["meteor://ðŸ’»app/packages/clinical:base-model/lib/BaseModel.js","meteor://ðŸ’»app/packages/clinical:base-model/lib/security.js"],"names":["SimpleSchema","module","link","v","Object","create","thing","prototype","arguments","length","Error","TypeError","result","diff","a","b","keys","_","map","k","omit","BaseModel","createEmpty","_id","extend","child","document","_document","constructor","_parent_","_super_","extendAndSetupCollection","collectionName","model","collection","_collection","Mongo","Collection","transform","Meteor","appendSchema","schemaObject","schema","attachSchema","_validator","newContext","methods","methodMap","self","isObject","each","method","name","isFunction","_getSchema","_c2","_simpleSchema","_checkCollectionExists","getCollectionName","_name","checkOwnership","userId","save","callback","obj","value","key","console","log","update","$set","isClient","clean","insert","modifier","_updateLocal","set","remove","validate","options","validator","denyUntrusted","isSet","autoValue","definition","call","defaultValue","isFromTrustedCode"],"mappings":"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","file":"/packages/clinical_base-model.js","sourcesContent":["import SimpleSchema from 'simpl-schema';\n\n\nif (typeof Object.create !== 'function') {\n  Object.create = (function () {\n    var thing = function () {};\n    return function (prototype) {\n      if (arguments.length > 1) {\n        throw Error('Second argument not supported');\n      }\n      if (typeof prototype !== 'object') {\n        throw TypeError('Argument must be an object');\n      }\n      thing.prototype = prototype;\n      var result = new thing();\n      thing.prototype = null;\n      return result;\n    };\n  })();\n}\n\nvar diff = function (a, b) {\n  var keys = _.map(a, function (v, k) {\n    if (b[k] === v) {\n      return k;\n    }\n  });\n  return _.omit(a, keys);\n};\n\n\n\n/*globals BaseModel:true*/\n\nBaseModel = function () {};\n\nBaseModel.createEmpty = function (_id) {\n  return new this({\n    _id: _id\n  });\n};\n\nBaseModel.extend = function () {\n  var child = function (document) {\n    _.extend(this, document);\n    this._document = document;\n  };\n\n  //add Static properties and methods\n  _.extend(child, this);\n\n  //prototypal inheritence\n  child.prototype = Object.create(this.prototype);\n  child.prototype.constructor = child;\n\n  //access to parent\n  child.prototype._parent_ = this;\n  child.prototype._super_ = this.prototype;\n\n  return child;\n};\n\nBaseModel.extendAndSetupCollection = function (collectionName) {\n  var model = this.extend();\n\n  model.collection = model.prototype._collection = new Mongo.Collection(collectionName, {\n    transform: function (document) {\n      return new model(document);\n    }\n  });\n\n  Meteor[collectionName] = model.collection;\n\n  return model;\n};\n\nBaseModel.appendSchema = function (schemaObject) {\n  var schema = new SimpleSchema(schemaObject);\n  var collection = this.prototype._collection;\n\n  if (collection) {\n    collection.attachSchema(schema);\n    this.prototype._validator = schema.newContext();\n  } else {\n    throw new Error(\n      \"Can't append schema to non existent collection. Either use extendAndSetupCollection() or assign a collection to Model.prototype._collection\"\n    );\n  }\n};\n\nBaseModel.methods = function (methodMap) {\n  var self = this;\n  if (_.isObject(methodMap)) {\n    _.each(methodMap, function (method, name) {\n      if (_.isFunction(method)) {\n        if (!self.prototype[name]) {\n          self.prototype[name] = method;\n        } else {\n          throw new Meteor.Error(\"existent-method\", \"The method \" + name + \" already exists.\");\n        }\n      }\n    });\n  }\n};\n\nBaseModel.prototype._getSchema = function () {\n  return this._collection._c2._simpleSchema;\n};\n\nBaseModel.prototype._checkCollectionExists = function () {\n  if (!this._collection) {\n    throw new Error(\n      \"No collection found. Either use extendAndSetupCollection() or assign a collection to Model.prototype._collection\"\n    );\n  }\n};\n\nBaseModel.prototype.getCollectionName = function () {\n  this._checkCollectionExists();\n  return this._collection._name;\n};\n\nBaseModel.prototype.checkOwnership = function () {\n  return this.userId === Meteor.userId();\n};\n\n// ===============================================\n// crud/persistence functions\n\nBaseModel.prototype.save = function (callback) {\n  this._checkCollectionExists();\n  var obj = {};\n  var schema = this._getSchema();\n\n  _.each(this, function (value, key) {\n    if (key !== \"_document\") {\n      obj[key] = value;\n    }\n  });\n\n\n  if (this._id) {\n    obj = diff(obj, this._document);\n    console.log(obj);\n    this._collection.update(this._id, {\n      $set: obj\n    }, callback);\n  } else {\n    if (Meteor.isClient && schema) {\n      obj = schema.clean(obj);\n    }\n    this._id = this._collection.insert(obj, callback);\n  }\n\n  return this;\n};\n\nBaseModel.prototype.update = function (modifier) {\n  if (this._id) {\n    this._checkCollectionExists();\n\n    this._collection.update(this._id, modifier);\n  }\n};\n\nBaseModel.prototype._updateLocal = function (modifier) {\n  this._collection._collection.update(this._id, modifier);\n};\n\nBaseModel.prototype.set = function (key, value) {\n  var obj = {};\n  obj[key] = value;\n  this[key] = value;\n  this._id && this._updateLocal({\n    $set: obj\n  });\n  return this;\n};\n\nBaseModel.prototype.remove = function () {\n  if (this._id) {\n    this._checkCollectionExists();\n\n    this._collection.remove({\n      _id: this._id\n    });\n  }\n};\n\n// ===============================================\n// validation functions\n\nBaseModel.prototype.clean = function () {\n  if(this._collection._c2._simpleSchema){\n    return this._collection._c2._simpleSchema.clean(this._document);\n  }\n};\n\nBaseModel.prototype.validate = function (options) {\n  var validator = this.prototype._validator;\n\n  if (validator) {\n    validator.validate(this, options)\n  } else {\n    throw new Error(\n      \"Can't validate document when object doesn't have a schema and validation context. Use .appendSchema()\"\n      );\n  }\n};\n","import SimpleSchema from 'simpl-schema';\n\n// SimpleSchema.messages({Untrusted: \"Inserts/Updates from untrusted code not supported\"});\n\nSimpleSchema.denyUntrusted = function() {\n    if(this.isSet){\n        var autoValue = this.definition.autoValue && this.definition.autoValue.call(this);\n        var defaultValue = this.definition.defaultValue;\n\n        if(this.value != defaultValue && this.value != autoValue && !this.isFromTrustedCode){\n            return \"Untrusted\";\n        }\n    }\n};\n"]}