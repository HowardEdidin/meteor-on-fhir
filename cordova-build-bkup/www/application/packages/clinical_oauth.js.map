{"version":3,"sources":["meteor://ðŸ’»app/packages/clinical:oauth/oauth_client.js","meteor://ðŸ’»app/packages/clinical:oauth/oauth_cordova.js","meteor://ðŸ’»app/packages/clinical:oauth/oauth_common.js","meteor://ðŸ’»app/packages/clinical:oauth/deprecated.js"],"names":["get","module","link","v","credentialSecrets","OAuth","showPopup","url","callback","dimensions","Meteor","console","log","Error","_loginStyle","service","config","options","isCordova","loginStyle","_","contains","sessionStorage","setItem","removeItem","e","_stateParam","credentialToken","redirectUrl","state","window","location","Base64","encode","JSON","stringify","saveDataForRedirect","loginService","Reload","_onMigrate","_migrate","immediateMigration","getDataAfterRedirect","migrationData","_migrationData","key","_storageTokenPrefix","credentialSecret","getItem","_debug","launchLogin","loginUrl","bind","credentialRequestCompleteCallback","popupOptions","initiateLogin","_handleCredentialSecret","secret","check","String","has","_retrieveCredentialSecret","localStorageKey","_localStorage","fail","err","oauthFinished","pageLoaded","event","indexOf","absoluteUrl","splitUrl","split","hashFragment","credentials","parse","decodeURIComponent","setTimeout","popup","close","onExit","removeEventListener","open","addEventListener","show","_redirectUri","serviceName","params","absoluteUrlOptions","process","env","DEBUG","query","isAndroid","clone","cordova","android","isEmpty","undefined","isServer","rootUrl","MOBILE_ROOT_URL","__meteor_runtime_config__","ROOT_URL","Npm","require","parsedRootUrl","hostname","host","format","extend","URL","_constructUrl","Oauth"],"mappings":"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","file":"/packages/clinical_oauth.js","sourcesContent":["import { get } from 'lodash';\n\n// credentialToken -> credentialSecret. You must provide both the\n// credentialToken and the credentialSecret to retrieve an access token from\n// the _pendingCredentials collection.\nvar credentialSecrets = {};\n\nOAuth = {};\n\nOAuth.showPopup = function (url, callback, dimensions) {\n  if(get(Meteor, 'settings.public.logging') === \"debug\"){\n    console.log('OAuth.showPopup()', url)\n  }  \n\n  throw new Error(\"OAuth.showPopup must be implemented on this arch.\");\n};\n\n// Determine the login style (popup or redirect) for this login flow.\n//\n//\nOAuth._loginStyle = function (service, config, options) {\n  if(get(Meteor, 'settings.public.logging') === \"debug\"){\n    console.log('C5.     Determining which login style to use.')\n  }  \n\n  if (Meteor.isCordova) {\n    return \"popup\";\n  }\n\n  var loginStyle = (options && options.loginStyle) || config.loginStyle || 'popup';\n\n  if (! _.contains([\"popup\", \"redirect\"], loginStyle))\n    throw new Error(\"Invalid login style: \" + loginStyle);\n\n  // If we don't have session storage (for example, Safari in private\n  // mode), the redirect login flow won't work, so fallback to the\n  // popup style.\n  if (loginStyle === 'redirect') {\n    try {\n      sessionStorage.setItem('Meteor.oauth.test', 'test');\n      sessionStorage.removeItem('Meteor.oauth.test');\n    } catch (e) {\n      loginStyle = 'popup';\n    }\n  }\n\n  return loginStyle;\n};\n\nOAuth._stateParam = function (loginStyle, credentialToken, redirectUrl) {\n  var state = {\n    loginStyle: loginStyle,\n    credentialToken: credentialToken,\n    isCordova: Meteor.isCordova\n  };\n\n  if (loginStyle === 'redirect')\n    state.redirectUrl = redirectUrl || ('' + window.location);\n\n  if(get(Meteor, 'settings.public.logging') === \"debug\"){\n    console.log('C6.     Encoding state as base64 JSON', state)\n  }  \n  \n  // Encode base64 as not all login services URI-encode the state\n  // parameter when they pass it back to us.\n  // Use the 'base64' package here because 'btoa' isn't supported in IE8/9.\n  return Base64.encode(JSON.stringify(state));\n};\n\n\n// At the beginning of the redirect login flow, before we redirect to\n// the login service, save the credential token for this login attempt\n// in the reload migration data.\n//\nOAuth.saveDataForRedirect = function (loginService, credentialToken) {\n  if(get(Meteor, 'settings.public.logging') === \"debug\"){\n    console.log('OAuth.saveDataForRedirect', loginService)\n  }  \n\n  Reload._onMigrate('oauth', function () {\n    return [true, {loginService: loginService, credentialToken: credentialToken}];\n  });\n  Reload._migrate(null, {immediateMigration: true});\n};\n\n// At the end of the redirect login flow, when we've redirected back\n// to the application, retrieve the credentialToken and (if the login\n// was successful) the credentialSecret.\n//\n// Called at application startup.  Returns null if this is normal\n// application startup and we weren't just redirected at the end of\n// the login flow.\n//\nOAuth.getDataAfterRedirect = function () {\n  if(get(Meteor, 'settings.public.logging') === \"debug\"){\n    console.log('Authentication subsystem online and ready for requests.')\n  }  \n\n  var migrationData = Reload._migrationData('oauth');\n\n  if (! (migrationData && migrationData.credentialToken))\n    return null;\n\n  var credentialToken = migrationData.credentialToken;\n  var key = OAuth._storageTokenPrefix + credentialToken;\n  var credentialSecret;\n  try {\n    credentialSecret = sessionStorage.getItem(key);\n    sessionStorage.removeItem(key);\n  } catch (e) {\n    Meteor._debug('error retrieving credentialSecret', e);\n  }\n  return {\n    loginService: migrationData.loginService,\n    credentialToken: credentialToken,\n    credentialSecret: credentialSecret\n  };\n};\n\n// Launch an OAuth login flow.  For the popup login style, show the\n// popup.  For the redirect login style, save the credential token for\n// this login attempt in the reload migration data, and redirect to\n// the service for the login.\n//\n// options:\n//  loginService: \"facebook\", \"google\", etc.\n//  loginStyle: \"popup\" or \"redirect\"\n//  loginUrl: The URL at the login service provider to start the OAuth flow.\n//  credentialRequestCompleteCallback: for the popup flow, call when the popup\n//    is closed and we have the credential from the login service.\n//  credentialToken: our identifier for this login flow.\n//\nOAuth.launchLogin = function (options) {\n  if(get(Meteor, 'settings.public.logging') === \"debug\"){\n    console.log('C7.1    Launching OAuth login.', options);\n  }  \n\n  if (! options.loginService)\n    throw new Error('loginService required');\n  if (options.loginStyle === 'popup') {\n    if(get(Meteor, 'settings.public.logging') === \"debug\"){\n      console.log('C7.2.   Showing the popup window...')\n    }  \n    OAuth.showPopup(\n      options.loginUrl,\n      _.bind(options.credentialRequestCompleteCallback, null, options.credentialToken),\n      options.popupOptions);\n  } else if (options.loginStyle === 'redirect') {\n    OAuth.saveDataForRedirect(options.loginService, options.credentialToken);\n    window.location = options.loginUrl;\n  } else {\n    throw new Error('invalid login style');\n  }\n};\n\n// XXX COMPAT WITH 0.7.0.1\n// Private interface but probably used by many oauth clients in atmosphere.\nOAuth.initiateLogin = function (credentialToken, url, callback, dimensions) {\n  if(get(Meteor, 'settings.public.logging') === \"debug\"){\n    console.log('OAuth.initiateLogin', credentialToken, url)\n  }  \n\n  OAuth.showPopup(\n    url,\n    _.bind(callback, null, credentialToken),\n    dimensions\n  );\n};\n\n// Called by the popup when the OAuth flow is completed, right before\n// the popup closes.\nOAuth._handleCredentialSecret = function (credentialToken, secret) {\n  if(get(Meteor, 'settings.public.logging') === \"debug\"){\n    console.log('OAuth._handleCredentialSecret', credentialToken, secret)\n  }  \n  check(credentialToken, String);\n  check(secret, String);\n  if (! _.has(credentialSecrets,credentialToken)) {\n    credentialSecrets[credentialToken] = secret;\n  } else {\n    throw new Error(\"Duplicate credential token from OAuth login\");\n  }\n};\n\n// Used by accounts-oauth, which needs both a credentialToken and the\n// corresponding to credential secret to call the `login` method over DDP.\nOAuth._retrieveCredentialSecret = function (credentialToken) {\n  if(get(Meteor, 'settings.public.logging') === \"debug\"){\n    console.log('C10.    Retrieving credential secret', credentialToken)\n  }  \n\n  // First check the secrets collected by OAuth._handleCredentialSecret,\n  // then check localStorage. This matches what we do in\n  // end_of_login_response.html.\n  var secret = credentialSecrets[credentialToken];\n  if (! secret) {\n    var localStorageKey = OAuth._storageTokenPrefix + credentialToken;\n    secret = Meteor._localStorage.getItem(localStorageKey);\n    Meteor._localStorage.removeItem(localStorageKey);\n  } else {\n    delete credentialSecrets[credentialToken];\n  }\n  return secret;\n};\n","// Cordova specific code for the OAuth package.\n\n// Open a popup window, centered on the screen, and call a callback when it\n// closes.\n//\n// @param url {String} url to show\n// @param callback {Function} Callback function to call on completion. Takes no\n//   arguments.\n// @param dimensions {optional Object(width, height)} The dimensions of\n//   the popup. If not passed defaults to something sane.\nOAuth.showPopup = function (url, callback, dimensions) {\n  var fail = function (err) {\n    Meteor._debug(\"Error from OAuth popup\", err);\n  };\n\n  // When running on an android device, we sometimes see the\n  // `pageLoaded` callback fire twice for the final page in the OAuth\n  // popup, even though the page only loads once. This is maybe an\n  // Android bug or maybe something intentional about how onPageFinished\n  // works that we don't understand and isn't well-documented.\n  var oauthFinished = false;\n\n  var pageLoaded = function (event) {\n    if (oauthFinished) {\n      return;\n    }\n\n    if (event.url.indexOf(Meteor.absoluteUrl('_oauth')) === 0) {\n      var splitUrl = event.url.split(\"#\");\n      var hashFragment = splitUrl[1];\n\n      if (! hashFragment) {\n        throw new Error(\"No hash fragment in OAuth popup?\");\n      }\n\n      var credentials = JSON.parse(decodeURIComponent(hashFragment));\n      OAuth._handleCredentialSecret(credentials.credentialToken,\n                                    credentials.credentialSecret);\n\n      oauthFinished = true;\n\n      // On iOS, this seems to prevent \"Warning: Attempt to dismiss from\n      // view controller <MainViewController: ...> while a presentation\n      // or dismiss is in progress\". My guess is that the last\n      // navigation of the OAuth popup is still in progress while we try\n      // to close the popup. See\n      // https://issues.apache.org/jira/browse/CB-2285.\n      //\n      // XXX Can we make this timeout smaller?\n      setTimeout(function () {\n        popup.close();\n        callback();\n      }, 100);\n    }\n  };\n\n  var onExit = function () {\n    popup.removeEventListener('loadstop', pageLoaded);\n    popup.removeEventListener('loaderror', fail);\n    popup.removeEventListener('exit', onExit);\n  };\n\n  var popup = window.open(url, '_blank', 'location=yes,hidden=yes');\n  popup.addEventListener('loadstop', pageLoaded);\n  popup.addEventListener('loaderror', fail);\n  popup.addEventListener('exit', onExit);\n  popup.show();\n\n};\n","import { get } from 'lodash';\n\nOAuth._storageTokenPrefix = \"Meteor.oauth.credentialSecret-\";\n\nOAuth._redirectUri = function (serviceName, config, params, absoluteUrlOptions) {\n  if(get(Meteor, 'settings.public.logging') === \"debug\"){\n    process.env.DEBUG && console.log('S10.1.1 OAuth._redirectUri()');\n  }\n  \n  // XXX COMPAT WITH 0.9.0\n  // The redirect URI used to have a \"?close\" query argument.  We\n  // detect whether we need to be backwards compatible by checking for\n  // the absence of the `loginStyle` field, which wasn't used in the\n  // code which had the \"?close\" argument.\n  // This logic is duplicated in the tool so that the tool can do OAuth\n  // flow with <= 0.9.0 servers (tools/auth.js).\n  var query = config.loginStyle ? null : \"close\";\n\n  // Clone because we're going to mutate 'params'. The 'cordova' and\n  // 'android' parameters are only used for picking the host of the\n  // redirect URL, and not actually included in the redirect URL itself.\n  var isCordova = false;\n  var isAndroid = false;\n  if (params) {\n    params = _.clone(params);\n    isCordova = params.cordova;\n    isAndroid = params.android;\n    delete params.cordova;\n    delete params.android;\n    if (_.isEmpty(params)) {\n      params = undefined;\n    }\n  }\n\n  if (Meteor.isServer && isCordova) {\n    var rootUrl = process.env.MOBILE_ROOT_URL ||\n          __meteor_runtime_config__.ROOT_URL;\n\n    if (isAndroid) {\n      // Match the replace that we do in cordova boilerplate\n      // (boilerplate-generator package).\n      // XXX Maybe we should put this in a separate package or something\n      // that is used here and by boilerplate-generator? Or maybe\n      // `Meteor.absoluteUrl` should know how to do this?\n      var url = Npm.require(\"url\");\n      var parsedRootUrl = url.parse(rootUrl);\n      if (parsedRootUrl.hostname === \"localhost\") {\n        parsedRootUrl.hostname = \"10.0.2.2\";\n        delete parsedRootUrl.host;\n      }\n      rootUrl = url.format(parsedRootUrl);\n    }\n\n    absoluteUrlOptions = _.extend({}, absoluteUrlOptions, {\n      // For Cordova clients, redirect to the special Cordova root url\n      // (likely a local IP in development mode).\n      rootUrl: rootUrl\n    });\n  }\n\n  return URL._constructUrl(\n    Meteor.absoluteUrl('_oauth/' + serviceName, absoluteUrlOptions),\n    query,\n    params);\n};\n","// XXX COMPAT WITH 0.8.0\n\nOauth = OAuth;\n"]}